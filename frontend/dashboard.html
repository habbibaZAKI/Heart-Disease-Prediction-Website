<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Heart Disease Analytics Dashboard</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background-color: #f4f7f6; }
        nav { background: #1976d2; padding: 15px; display: flex; justify-content: space-between; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        nav a { color: white; text-decoration: none; margin-right: 15px; font-weight: bold; }
        
        .container { padding: 30px; max-width: 1200px; margin: auto; }
        h2 { color: #1976d2; border-bottom: 2px solid #ddd; padding-bottom: 10px; }
        
        /* Stats Cards */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin: 20px 0; }
        .stat-card { background: white; padding: 20px; border-radius: 12px; text-align: center; box-shadow: 0 4px 6px rgba(0,0,0,0.05); border-top: 5px solid #1976d2; transition: 0.3s; }
        .stat-card:hover { transform: translateY(-5px); }
        .stat-card h3 { font-size: 13px; color: #888; text-transform: uppercase; margin-bottom: 10px; }
        .stat-card p { font-size: 26px; font-weight: bold; color: #333; margin: 0; }

        /* Charts Layout */
        .charts-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(480px, 1fr)); gap: 25px; margin-top: 30px; }
        .chart-box { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.08); text-align: center; }
        .chart-box strong { display: block; margin-bottom: 15px; color: #555; font-size: 16px; }
        .chart-box img { width: 100%; height: auto; border-radius: 8px; }
        
        .error-msg { color: #d32f2f; text-align: center; display: none; padding: 20px; background: #ffebee; border-radius: 10px; margin-bottom: 20px; }

        @media (max-width: 600px) { .charts-grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

<nav>
    <div class="links">
        <a href="dashboard.html">Dashboard</a>
        <a href="index.html">Prediction</a>
        <a href="profile.html">Profile</a>
    </div>
    <a href="#" onclick="logout()" style="color: #ffcdd2;">Logout</a>
</nav>

<div class="container">
    <h2>Analytics Dashboard</h2>
    <div id="errorMessage" class="error-msg">Failed to load dashboard data. Ensure the backend is running and the "Dataset" collection is populated.</div>

    <div class="stats-grid">
        <div class="stat-card"><h3>Total Samples</h3><p id="totalCount">...</p></div>
        <div class="stat-card"><h3>Mean Age</h3><p id="meanAge">...</p></div>
        <div class="stat-card"><h3>Median Cholesterol</h3><p id="medianChol">...</p></div>
        <div class="stat-card"><h3>Max Heart Rate</h3><p id="maxHR">...</p></div>
    </div>

    <div class="charts-grid">
        <div class="chart-box"><strong>Age Distribution (Histogram)</strong><img id="histImg" src=""></div>
        <div class="chart-box"><strong>Gender Distribution (Pie Chart)</strong><img id="pieImg" src=""></div>
        <div class="chart-box"><strong>Chest Pain Analysis (Bar Chart)</strong><img id="barImg" src=""></div>
        <div class="chart-box"><strong>Cholesterol Trends (Line Plot)</strong><img id="lineImg" src=""></div>
    </div>
</div>

<script>
    async function loadDashboard() {
        // Auth Guard
        const user_email = localStorage.getItem("user_email");
        if (!user_email) { window.location.href = "login.html"; return; }

        try {
            const res = await fetch("http://127.0.0.1:8000/dashboard");
            if (!res.ok) throw new Error("Backend connection failed");
            const data = await res.json();

            // Populate Statistics
            document.getElementById("totalCount").innerText = data.stats.total_count;
            document.getElementById("meanAge").innerText = data.stats.mean_age + " yrs";
            document.getElementById("medianChol").innerText = data.stats.median_chol + " mg/dl";
            document.getElementById("maxHR").innerText = data.stats.max_heart_rate + " bpm";

            // Populate Chart Images
            document.getElementById("histImg").src = "data:image/png;base64," + data.charts.histogram;
            document.getElementById("pieImg").src = "data:image/png;base64," + data.charts.pie;
            document.getElementById("barImg").src = "data:image/png;base64," + data.charts.bar;
            document.getElementById("lineImg").src = "data:image/png;base64," + data.charts.line;

        } catch (err) {
            document.getElementById("errorMessage").style.display = "block";
            console.error(err);
        }
    }

    function logout() {
        localStorage.clear();
        window.location.href = "login.html";
    }

    window.onload = loadDashboard;
</script>
</body>
</html>