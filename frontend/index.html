<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="stylesheet" href="style.css">
    <meta charset="UTF-8">
    <title>Heart Disease Prediction</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        input, select { width: 100%; padding: 8px; margin: 5px 0; }
        button { padding: 10px 15px; margin-top: 10px; }
        nav a { margin-right: 15px; }
    </style>
</head>
<body>

<nav>
    <a href="dashboard.html">Dashboard</a>
    <a href="index.html">Prediction</a>
    <a href="profile.html">Profile</a>
    <a href="login.html" onclick="logout()">Logout</a>
</nav>

<h2>Heart Disease Prediction</h2>

<form id="predictionForm">
    <label>Age:</label>
    <input type="number" id="age" required>

    <label>Sex (0=Female, 1=Male):</label>
    <input type="number" id="sex" min="0" max="1" required>

    <label>Chest Pain Type (0-3):</label>
    <input type="number" id="cp" min="0" max="3" required>

    <label>Resting Blood Pressure:</label>
    <input type="number" id="trestbps" required>

    <label>Cholesterol:</label>
    <input type="number" id="chol" required>

    <label>Fasting Blood Sugar (0 or 1):</label>
    <input type="number" id="fbs" min="0" max="1" required>

    <label>Resting ECG (0-2):</label>
    <input type="number" id="restecg" min="0" max="2" required>

    <label>Max Heart Rate Achieved:</label>
    <input type="number" id="thalach" required>

    <label>Exercise Induced Angina (0 or 1):</label>
    <input type="number" id="exang" min="0" max="1" required>

    <label>Oldpeak:</label>
    <input type="number" step="0.1" id="oldpeak" required>

    <label>Slope (0-2):</label>
    <input type="number" id="slope" min="0" max="2" required>

    <label>Number of Major Vessels (0-3):</label>
    <input type="number" id="ca" min="0" max="3" required>

    <label>Thal (1-3):</label>
    <input type="number" id="thal" min="1" max="3" required>

    <button type="submit">Predict</button>
</form>

<script>
    // Check if user is logged in
    const user_email = localStorage.getItem("user_email");
    if (!user_email) {
        alert("You must be logged in to make predictions");
        window.location.href = "login.html";
    }

    // Logout function
    function logout() {
        localStorage.removeItem("user_email");
        localStorage.removeItem("user_name");
        localStorage.removeItem("latest_prediction");
    }

    // Form submit
    document.getElementById("predictionForm").addEventListener("submit", async function(event) {
        event.preventDefault();

        const data = {
            age: parseInt(document.getElementById("age").value),
            sex: parseInt(document.getElementById("sex").value),
            cp: parseInt(document.getElementById("cp").value),
            trestbps: parseInt(document.getElementById("trestbps").value),
            chol: parseInt(document.getElementById("chol").value),
            fbs: parseInt(document.getElementById("fbs").value),
            restecg: parseInt(document.getElementById("restecg").value),
            thalach: parseInt(document.getElementById("thalach").value),
            exang: parseInt(document.getElementById("exang").value),
            oldpeak: parseFloat(document.getElementById("oldpeak").value),
            slope: parseInt(document.getElementById("slope").value),
            ca: parseInt(document.getElementById("ca").value),
            thal: parseInt(document.getElementById("thal").value)
        };

        try {
            // âœ… Wrap data and user_email to match FastAPI PredictionRequest model
            const response = await fetch("http://127.0.0.1:8000/predict", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    user_email: user_email,
                    data: data
                })
            });

            const result = await response.json();

            if (!response.ok) {
                throw new Error(result.detail || "Prediction failed");
            }

            // Save prediction to localStorage
            localStorage.setItem("latest_prediction", result.prediction);

            // Redirect to results page
            window.location.href = "result.html";

        } catch (error) {
            console.error(error);
            alert("Error connecting to server: " + error.message);
        }
    });
</script>

</body>
</html>
